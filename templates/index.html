<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ quiz.title }} - Quiz</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1 class="quiz-title">{{ quiz.title }}</h1>
            <div class="timer-container">
                <div class="timer-display" id="timer">
                    <span id="timer-minutes">00</span>:<span id="timer-seconds">00</span>
                </div>
                <div class="timer-label">Time Remaining</div>
            </div>
        </header>

        <div id="start-screen" class="screen">
            <div class="welcome-box">
                <h2>Welcome!</h2>
                <p class="start-message">{{ quiz.start_message }}</p>
                
                <form id="name-form" onsubmit="startQuiz(event)">
                    <label for="student-name">Your Full Name:</label>
                    <input type="text" id="student-name" name="student-name" required 
                           placeholder="Enter your full name" autocomplete="name">
                    <button type="submit" class="btn-primary">Start Quiz</button>
                </form>
            </div>
        </div>

        <div id="quiz-screen" class="screen hidden">
            <form id="quiz-form">
                <div id="questions-container"></div>
                
                <div class="submit-section">
                    <button type="button" id="submit-btn" class="btn-primary" onclick="confirmSubmit()">
                        Submit Quiz
                    </button>
                    <p class="submit-warning">Please review your answers before submitting.</p>
                </div>
            </form>
        </div>

        <div id="submitted-screen" class="screen hidden">
            <div class="submitted-box">
                <h2>‚úì Quiz Submitted!</h2>
                <div class="multilang-message">
                    <p class="lang-message">üéì Good work! Consult your teacher to see how you did!</p>
                    <p class="lang-message" style="direction: rtl;">ÿπŸÖŸÑ ÿ¨ŸäÿØ! ÿßÿ≥ÿ™ÿ¥ÿ± ŸÖÿπŸÑŸÖŸÉ ŸÑÿ™ÿ±Ÿâ ŸÉŸäŸÅ ŸÉÿßŸÜ ÿ£ÿØÿßÿ§ŸÉ!</p>
                    <p class="lang-message">Bon travail ! Consultez votre professeur pour voir comment vous avez fait !</p>
                    <p class="lang-message">¬°Buen trabajo! ¬°Consulta a tu profesor para ver c√≥mo te fue!</p>
                    <p class="lang-message">Gute Arbeit! Fragen Sie Ihren Lehrer, wie Sie abgeschnitten haben!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Time's Up Modal -->
    <div id="timeup-modal" class="modal hidden">
        <div class="modal-content animated">
            <div class="modal-icon">‚è∞</div>
            <h2>Time's Up!</h2>
            <p>Your quiz has been automatically submitted.</p>
            <button onclick="closeTimeUpModal()" class="btn-primary">OK</button>
        </div>
    </div>

    <script>
        // Quiz data
        const quizData = {{ quiz | tojson }};
        let timeRemaining = {{ quiz.timer_minutes }} * 60; // seconds
        let timerInterval = null;
        let quizStarted = false;
        let submitted = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            syncTimer();
            setInterval(syncTimer, 5000); // Sync every 5 seconds
            loadQuestions();
        });

        function syncTimer() {
            fetch('/api/quiz_data')
                .then(response => response.json())
                .then(data => {
                    if (data.time_remaining_seconds !== undefined) {
                        const startTime = new Date(data.start_time);
                        const now = new Date();
                        const elapsed = (now - startTime) / 1000;
                        const timerMinutes = data.timer_minutes;
                        timeRemaining = Math.max(0, (timerMinutes * 60) - elapsed);
                        updateTimerDisplay();
                    }
                })
                .catch(err => console.error('Timer sync error:', err));
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    handleTimeUp();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = Math.floor(timeRemaining % 60);
            document.getElementById('timer-minutes').textContent = 
                String(minutes).padStart(2, '0');
            document.getElementById('timer-seconds').textContent = 
                String(seconds).padStart(2, '0');
            
            // Visual warning
            const timerEl = document.getElementById('timer');
            if (timeRemaining < 300) { // Less than 5 minutes
                timerEl.classList.add('warning');
            }
            if (timeRemaining < 60) { // Less than 1 minute
                timerEl.classList.add('critical');
            }
        }

        function startQuiz(event) {
            event.preventDefault();
            const studentName = document.getElementById('student-name').value.trim();
            if (!studentName && quizData.require_full_name) {
                alert('Please enter your full name');
                return;
            }
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            quizStarted = true;
            startTimer();
        }

        function loadQuestions() {
            const container = document.getElementById('questions-container');
            quizData.questions.forEach((question, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'question';
                qDiv.innerHTML = generateQuestionHTML(question, index);
                container.appendChild(qDiv);
            });
        }

        function generateQuestionHTML(question, index) {
            const type = question.type;
            const weight = question.weight || 1;
            let html = `<div class="question-header">
                <h3>Question ${index + 1} <span class="points">(${weight} point${weight !== 1 ? 's' : ''})</span></h3>
                <p class="question-text">${escapeHtml(question.text)}</p>
            </div>`;

            if (type === 'multiple_choice_single') {
                html += '<div class="options">';
                question.options.forEach((option, optIdx) => {
                    html += `<label class="radio-option">
                        <input type="radio" name="q${index}" value="${escapeHtml(option)}" required>
                        <span>${escapeHtml(option)}</span>
                    </label>`;
                });
                html += '</div>';
            } else if (type === 'multiple_choice_multiple') {
                html += '<div class="options">';
                question.options.forEach((option, optIdx) => {
                    html += `<label class="checkbox-option">
                        <input type="checkbox" name="q${index}" value="${escapeHtml(option)}">
                        <span>${escapeHtml(option)}</span>
                    </label>`;
                });
                html += '</div>';
            } else if (type === 'true_false') {
                html += '<div class="options">';
                html += `<label class="radio-option">
                    <input type="radio" name="q${index}" value="True" required>
                    <span>True</span>
                </label>`;
                html += `<label class="radio-option">
                    <input type="radio" name="q${index}" value="False" required>
                    <span>False</span>
                </label>`;
                html += '</div>';
            } else if (type === 'short_answer') {
                html += `<input type="text" name="q${index}" class="text-input" placeholder="Type your answer here" required>`;
            } else if (type === 'paragraph') {
                html += `<textarea name="q${index}" class="text-input paragraph-input" rows="5" placeholder="Type your answer here" required></textarea>`;
            }

            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function confirmSubmit() {
            if (submitted) return;
            
            if (confirm('Are you sure you want to submit your quiz? You cannot change your answers after submitting.')) {
                submitQuiz();
            }
        }

        function handleTimeUp() {
            if (submitted) return;
            submitted = true;
            
            // Disable all inputs
            document.querySelectorAll('input, textarea').forEach(el => {
                el.disabled = true;
            });
            
            // Show modal
            document.getElementById('timeup-modal').classList.remove('hidden');
            
            // Auto-submit after a moment
            setTimeout(() => {
                submitQuiz(true);
            }, 2000);
        }

        function closeTimeUpModal() {
            document.getElementById('timeup-modal').classList.add('hidden');
        }

        function submitQuiz(isAuto = false) {
            if (submitted) return;
            submitted = true;
            
            clearInterval(timerInterval);
            
            // Collect answers
            const answers = {};
            
            quizData.questions.forEach((question, index) => {
                const name = `q${index}`;
                if (question.type === 'multiple_choice_multiple') {
                    // For checkboxes, get all checked values
                    const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
                    answers[index] = Array.from(checkboxes).map(cb => cb.value);
                } else if (question.type === 'multiple_choice_single' || question.type === 'true_false') {
                    // For radio buttons, get the CHECKED one
                    const radio = document.querySelector(`input[name="${name}"]:checked`);
                    if (radio) {
                        answers[index] = radio.value;
                    }
                } else {
                    // For text inputs
                    const input = document.querySelector(`[name="${name}"]`);
                    if (input) {
                        answers[index] = input.value;
                    }
                }
            });
            
            const studentName = document.getElementById('student-name').value.trim();
            
            // Submit to server
            fetch('/api/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    student_name: studentName,
                    answers: answers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    submitted = false;
                } else {
                    // Hide quiz screen
                    document.getElementById('quiz-screen').classList.add('hidden');
                    document.getElementById('timeup-modal').classList.add('hidden');
                    
                    // Show submitted screen
                    document.getElementById('submitted-screen').classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Submit error:', error);
                alert('An error occurred while submitting. Please try again.');
                submitted = false;
            });
        }

        // Prevent accidental navigation
        window.addEventListener('beforeunload', function(e) {
            if (quizStarted && !submitted) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>

